# 프론트엔드 토큰 자동 갱신 구현 가이드

## 백엔드 변경 사항

백엔드에서 JWT 토큰 자동 갱신을 위한 기능이 추가되었습니다. 프론트엔드에서 토큰이 만료되기 **전에** 자동으로 갱신하여 401 에러 없이 사용할 수 있도록 구현해야 합니다.

### 변경된 API 응답 형식

#### 1. 로그인 API (`POST /api/auth/kakao`)
응답에 토큰 만료 시간 정보가 추가되었습니다:

```json
{
  "token": {
    "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "access_expires_at": 1735689600,    // Unix timestamp (초 단위)
    "refresh_expires_at": 1738281600    // Unix timestamp (초 단위)
  },
  "user": {
    "id": 123,
    "kakao_id": 4424485763,
    "nickname": "사용자",
    "profile_image_url": "https://..."
  },
  "is_new": false
}
```

#### 2. 토큰 갱신 API (`POST /api/auth/refresh` 또는 `POST /api/auth/token/refresh/`)
요청:
```json
{
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

응답:
```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "access_expires_at": 1735689600,    // 새 토큰의 만료 시간
  "refresh_expires_at": 1738281600
}
```

#### 3. 토큰 검증 API (`GET /api/auth/verify`) - 새로 추가됨
현재 ACCESS_TOKEN의 유효성과 만료까지 남은 시간을 확인할 수 있습니다.

요청 헤더:
```
Authorization: Bearer {access_token}
```

응답 (성공):
```json
{
  "valid": true,
  "expires_at": 1735689600,      // Unix timestamp
  "expires_in": 86400,            // 남은 시간 (초 단위)
  "user_id": 123
}
```

응답 (실패):
```json
{
  "valid": false,
  "detail": "Token is invalid or expired",
  "code": "token_not_valid"
}
```

### 토큰 만료 시간
- **ACCESS_TOKEN**: 24시간
- **REFRESH_TOKEN**: 30일

## 구현해야 할 기능

### 1. 토큰 저장 및 관리
- 로그인/토큰 갱신 시 `access_expires_at`과 함께 토큰을 저장
- AsyncStorage 또는 SecureStore에 저장

### 2. 토큰 만료 전 자동 갱신
**핵심**: ACCESS_TOKEN이 만료되기 **5분 전**에 자동으로 갱신해야 합니다.

구현 방법:
1. **주기적 체크 방식**
   - 앱이 포그라운드에 있을 때 주기적으로(예: 1분마다) 토큰 만료 시간 확인
   - `access_expires_at - 현재시간 < 300초(5분)` 이면 자동 갱신

2. **타이머 방식**
   - 토큰을 받을 때마다 만료 5분 전에 실행될 타이머 설정
   - 타이머가 실행되면 자동으로 토큰 갱신

### 3. API 요청 인터셉터
모든 API 요청에서 401 에러 발생 시 자동으로 토큰 갱신 후 재시도:

```
API 요청 → 401 에러 발생
  ↓
토큰 갱신 API 호출
  ↓
새 토큰으로 원래 요청 재시도
  ↓
성공 응답 반환
```

### 4. 토큰 갱신 함수 예시

```typescript
// 예시 코드 (TypeScript/React Native)
async function refreshToken(): Promise<boolean> {
  try {
    const refreshToken = await AsyncStorage.getItem('refresh_token');
    if (!refreshToken) {
      // 로그아웃 처리
      return false;
    }

    const response = await fetch(`${API_BASE_URL}/api/auth/refresh`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ refresh: refreshToken }),
    });

    if (response.ok) {
      const data = await response.json();
      
      // 새 토큰 저장
      await AsyncStorage.setItem('access_token', data.access);
      await AsyncStorage.setItem('refresh_token', data.refresh);
      await AsyncStorage.setItem('access_expires_at', data.access_expires_at.toString());
      
      // 만료 5분 전에 다시 갱신하도록 타이머 설정
      scheduleTokenRefresh(data.access_expires_at);
      
      return true;
    } else {
      // Refresh token도 만료됨 → 로그아웃
      await logout();
      return false;
    }
  } catch (error) {
    console.error('Token refresh failed:', error);
    return false;
  }
}

function scheduleTokenRefresh(expiresAt: number) {
  const now = Math.floor(Date.now() / 1000);
  const expiresIn = expiresAt - now;
  const refreshBefore = expiresIn - 300; // 5분 전에 갱신
  
  if (refreshBefore > 0) {
    setTimeout(() => {
      refreshToken();
    }, refreshBefore * 1000);
  }
}
```

### 5. API 요청 인터셉터 예시

```typescript
// Axios 인터셉터 예시
axios.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;

    // 401 에러이고 아직 재시도하지 않은 경우
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;

      // 토큰 갱신
      const refreshed = await refreshToken();
      
      if (refreshed) {
        // 새 토큰으로 원래 요청 재시도
        const newAccessToken = await AsyncStorage.getItem('access_token');
        originalRequest.headers.Authorization = `Bearer ${newAccessToken}`;
        return axios(originalRequest);
      } else {
        // 토큰 갱신 실패 → 로그아웃
        await logout();
        return Promise.reject(error);
      }
    }

    return Promise.reject(error);
  }
);
```

## 구현 체크리스트

- [ ] 로그인 시 `access_expires_at` 저장
- [ ] 토큰 갱신 시 `access_expires_at` 업데이트
- [ ] 토큰 만료 5분 전 자동 갱신 로직 구현
- [ ] API 요청 인터셉터에서 401 에러 시 자동 갱신 후 재시도
- [ ] 앱 시작 시 토큰 만료 시간 확인 및 필요시 갱신
- [ ] 앱이 포그라운드로 돌아올 때 토큰 상태 확인
- [ ] Refresh token도 만료된 경우 로그아웃 처리

## 중요 사항

1. **토큰은 만료되기 전에 갱신해야 합니다**
   - 만료된 후 갱신하면 사용자가 401 에러를 경험하게 됩니다
   - 최소 5분 전에 갱신하는 것을 권장합니다

2. **동시 요청 처리**
   - 여러 API 요청이 동시에 401을 받을 수 있습니다
   - 토큰 갱신이 진행 중일 때는 대기하고, 완료 후 모든 요청을 재시도해야 합니다

3. **토큰 저장 보안**
   - ACCESS_TOKEN과 REFRESH_TOKEN을 안전하게 저장하세요
   - React Native의 경우 SecureStore 사용을 권장합니다

4. **에러 처리**
   - Refresh token도 만료된 경우 사용자를 로그아웃 처리해야 합니다
   - 네트워크 오류 시 재시도 로직을 구현하세요

## 테스트 시나리오

1. 로그인 후 24시간 동안 토큰이 자동 갱신되는지 확인
2. 여러 API를 동시에 호출할 때 토큰 갱신이 한 번만 발생하는지 확인
3. 네트워크가 끊긴 상태에서 토큰 갱신 시도 시 적절한 에러 처리 확인
4. 앱을 백그라운드로 보냈다가 다시 포그라운드로 가져올 때 토큰 상태 확인

