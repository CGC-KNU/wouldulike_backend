# 쿠폰 발급 이벤트 로깅 가이드 (Firebase)

> `issued_coupons` 응답의 `campaign_code`, `coupon_type_code`, `issue_key`를 활용해 Firebase `coupon_issued` 이벤트에서 발급 경로·기획전 종류를 구분합니다.

---

## 1. issued_coupons 응답 형식

쿠폰 발급 API 응답에 포함되는 `issued_coupons` 형식:

```json
{
  "issued_coupons": [
    {
      "code": "ABC123",
      "restaurant_id": 101,
      "issue_key": "EVENT_REWARD:42:XYZ789",
      "campaign_code": "EVENT_REWARD_SIGNUP",
      "coupon_type_code": "WELCOME_3000"
    }
  ]
}
```

| 필드 | 설명 | 예시 |
|------|------|------|
| `code` | 쿠폰 코드 | `"ABC123"` |
| `restaurant_id` | 사용 가능 매장 ID (없으면 null) | `101` 또는 `null` |
| `issue_key` | 발급 경로 식별용 키 | `"EVENT_REWARD:42:XYZ789"` |
| `campaign_code` | 캠페인 코드 (기획전 종류 구분) | `"EVENT_REWARD_SIGNUP"` |
| `coupon_type_code` | 쿠폰 타입 코드 | `"WELCOME_3000"` |

---

## 2. 발급 경로·기획전 종류 구분표

| 발급 방식 | campaign_code | coupon_type_code | issue_key prefix |
|-----------|---------------|------------------|------------------|
| **회원가입** | SIGNUP_WELCOME | WELCOME_3000 | SIGNUP: |
| **앱 오픈** | SIGNUP_WELCOME | WELCOME_3000 (환경변수) | APP_OPEN: |
| **일괄 전송** (카카오 ID) | SIGNUP_WELCOME | WELCOME_3000 | AMBASSADOR: |
| **일반 친구초대 (추천인)** | REFERRAL | REFERRAL_BONUS_REFERRER | REFERRAL_REFERRER: |
| **일반 친구초대 (피추천인)** | REFERRAL | REFERRAL_BONUS_REFEREE | REFERRAL_REFEREE: |
| **기획전 - 신규가입** | EVENT_REWARD_SIGNUP | WELCOME_3000 | EVENT_REWARD: |
| **기획전 - 친구초대** | EVENT_REWARD_REFERRAL | REFERRAL_BONUS_REFEREE | EVENT_REWARD: |
| **플래시** | FLASH_8PM | FLASH_3000 | FLASH: |
| **기말고사** | FINAL_EXAM_EVENT | FINAL_EXAM_SPECIAL | FINAL_EXAM: |
| **스탬프 보상** | STAMP_REWARD | STAMP_REWARD_5 등 | STAMP_REWARD: |

---

## 3. Firebase coupon_issued 이벤트 파라미터

**권장: `campaign_code`를 `coupon_issue_source`로 사용**

```javascript
// issued_coupons를 순회하며 coupon_issued 이벤트 전송
const issuedCoupons = response.data?.issued_coupons ?? [];
issuedCoupons.forEach((c) => {
  analytics.logEvent('coupon_issued', {
    restaurant_id: c.restaurant_id,
    coupon_issue_source: c.campaign_code ?? getIssueSourceFromIssueKey(c.issue_key),
    coupon_type_code: c.coupon_type_code,
    coupon_code: c.code,
  });
});

// campaign_code가 없을 때 issue_key로 fallback
function getIssueSourceFromIssueKey(issueKey) {
  if (!issueKey) return 'unknown';
  if (issueKey.startsWith('APP_OPEN:')) return 'app_open';
  if (issueKey.startsWith('AMBASSADOR:')) return 'bulk';
  if (issueKey.startsWith('REFERRAL_REFERRER:')) return 'referrer';
  if (issueKey.startsWith('REFERRAL_REFEREE:')) return 'referee';
  if (issueKey.startsWith('EVENT_REWARD:')) return 'event_reward';  // campaign_code로 세부 구분
  if (issueKey.startsWith('SIGNUP:')) return 'signup';
  if (issueKey.startsWith('FLASH:')) return 'flash';
  if (issueKey.startsWith('FINAL_EXAM:')) return 'final_exam';
  if (issueKey.startsWith('STAMP_REWARD:')) return 'stamp';
  return 'other';
}
```

---

## 4. 기획전 종류 구분

**같은 `issue_key` prefix(`EVENT_REWARD:`)를 쓰는 기획전은 `campaign_code`로 구분합니다.**

| campaign_code | 의미 |
|---------------|------|
| `EVENT_REWARD_SIGNUP` | 기획전 - 신규가입 보상 |
| `EVENT_REWARD_REFERRAL` | 기획전 - 친구초대 보상 |

Firebase에서 `coupon_issue_source: "EVENT_REWARD_SIGNUP"` 또는 `"EVENT_REWARD_REFERRAL"`로 기획전 종류별 전환율 분석이 가능합니다.

---

## 5. 적용 API 목록

| API | issued_coupons 포함 |
|-----|---------------------|
| POST /api/coupons/signup/complete/ | ✅ |
| GET /api/coupons/my/ | ✅ (앱 오픈 쿠폰 발급 시) |
| POST /api/coupons/referrals/accept/ | ✅ |
| POST /api/coupons/referrals/qualify/ | ✅ |
| POST /api/coupons/flash/claim/ | ✅ |
| POST /api/coupons/final-exam/claim/ | ✅ |
| POST /api/coupons/stamps/add/ | reward_coupon_codes / reward_coupons (별도 형식) |
