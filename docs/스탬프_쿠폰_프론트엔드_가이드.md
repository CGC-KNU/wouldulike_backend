# 스탬프 적립 및 쿠폰 발급 - 프론트엔드 연동 가이드

> 백엔드 스탬프 시스템 변경 사항을 반영하기 위한 프론트엔드 수정 요청 문서입니다.

---

## 1. 변경 요약

| 구분 | 기존 | 변경 후 |
|------|------|---------|
| 발급 기준 | 모든 식당 고정 **5개, 10개** | **식당별 상이** (예: 1,3,5,7,10 / 1,5,10 / 3,5,7,10 등) |
| 쿠폰 혜택 표시 | 하드코딩 | **API 응답 기반 동적 표시** |
| 쿠폰 사용 조건 | 없음 | **notes 필드** (사용 시 팝업에 표시) |
| 하루 적립 제한 | 2회 | **3회** |

---

## 2. 스탬프 적립 규칙

### 2.1 적립 제한
- **식당별 하루 최대 3회** 적립 가능
- 초과 시 에러: `"하루 최대 3번까지만 스탬프를 적립할 수 있습니다. 오늘 이미 N번 적립하셨습니다."`

### 2.2 발급 패턴 (식당별)
- **THRESHOLD**: 스탬프 누적 개수 기준 (예: 1, 3, 5, 7, 10개 도달 시 발급)
- **VISIT**: 방문 횟수 기준 (예: 1~4회→쿠폰A, 5~9회→쿠폰B, 10회→쿠폰C)

### 2.3 사이클
- 보통 10개 도달 시 쿠폰 발급 후 스탬프 10개 차감(리셋)
- `target` 값이 식당별 cycle_target (기본 10)

---

## 3. API 변경 사항

### 3.1 스탬프 현황 API - `rewards` 필드 추가

#### `GET /api/coupons/stamps/my/?restaurant_id={id}`

**기존 응답:**
```json
{
  "current": 3,
  "target": 10,
  "updated_at": "2025-02-25T12:00:00Z"
}
```

**변경 후 응답:**
```json
{
  "current": 3,
  "target": 10,
  "rewards": [
    {
      "stamps": 1,
      "title": "1개 보상",
      "subtitle": "3,000원 할인",
      "notes": "최소 주문 1만원",
      "benefit": {"type": "fixed", "value": 3000},
      "coupon_type_code": "STAMP_REWARD_1"
    },
    {
      "stamps": 5,
      "title": "5개 보상",
      "subtitle": "5,000원 할인",
      "notes": "음료만 사용 가능",
      "benefit": {"type": "fixed", "value": 5000},
      "coupon_type_code": "STAMP_REWARD_5"
    },
    {
      "stamps": 10,
      "title": "10개 보상",
      "subtitle": "10,000원 할인",
      "notes": "",
      "benefit": {"type": "fixed", "value": 10000},
      "coupon_type_code": "STAMP_REWARD_10"
    }
  ],
  "updated_at": "2025-02-25T12:00:00Z"
}
```

#### `GET /api/coupons/stamps/my/all/`

**변경 후:** 각 항목에 `rewards` 배열 추가
```json
{
  "results": [
    {
      "restaurant_id": 101,
      "current": 3,
      "target": 10,
      "rewards": [
        {"stamps": 1, "title": "1개 보상", "subtitle": "3,000원", "notes": "최소 주문 1만원", "benefit": {...}, "coupon_type_code": "STAMP_REWARD_1"},
        {"stamps": 5, "title": "5개 보상", "subtitle": "5,000원", "notes": "", "benefit": {...}, "coupon_type_code": "STAMP_REWARD_5"},
        {"stamps": 10, "title": "10개 보상", "subtitle": "10,000원", "notes": "", "benefit": {...}, "coupon_type_code": "STAMP_REWARD_10"}
      ],
      "updated_at": "..."
    }
  ]
}
```

**VISIT 패턴 식당**의 경우 `rewards` 구조:
```json
{
  "visit_range": "1_4",
  "min_visit": 1,
  "max_visit": 4,
  "title": "1~4회 보상",
  "subtitle": "3,000원",
  "notes": "",
  "benefit": {"type": "fixed", "value": 3000},
  "coupon_type_code": "STAMP_VISIT_1_4"
}
```

---

### 3.2 쿠폰 API - `benefit.notes` 활용

#### `GET /api/coupons/my/` (내 쿠폰 목록)

각 쿠폰의 `benefit` 객체에 `notes` 포함:
```json
{
  "code": "ABC123",
  "benefit": {
    "title": "5개 보상",
    "subtitle": "5,000원 할인",
    "notes": "음료만 사용 가능 / 1인 1회",
    "benefit": {"type": "fixed", "value": 5000},
    "restaurant_name": "OO식당",
    ...
  }
}
```

#### `POST /api/coupons/check/` (쿠폰 확인 - PIN 입력 시 호출)

**요청:** `{"coupon_code": "ABC123"}`

**응답:** `benefit`에 `notes` 포함
```json
{
  "code": "ABC123",
  "status": "ISSUED",
  "benefit": {
    "title": "5개 보상",
    "subtitle": "5,000원 할인",
    "notes": "음료만 사용 가능 / 1인 1회",
    "benefit": {"type": "fixed", "value": 5000},
    "restaurant_name": "OO식당",
    ...
  }
}
```

---

## 4. 프론트엔드 수정 요청 사항

### 4.1 [필수] 식당별 스탬프 혜택 동적 표시

**현재:** 제휴식당마다 "5개 적립 시 ~ 혜택", "10개 적립 시 ~ 혜택", "N개 남았다" 등을 **하드코딩**하고 있음.

**요청:** `GET /api/coupons/stamps/my/` 또는 `GET /api/coupons/stamps/my/all/` 응답의 **`rewards` 배열**을 사용하여 식당별로 동적으로 표시해 주세요.

- `rewards`의 각 항목: `stamps`(또는 `visit_range`), `title`, `subtitle`, `notes`, `benefit`
- 예: "1개 적립 시: 3,000원 할인", "5개 적립 시: 5,000원 할인" 등
- `target`과 `current`로 "N개 남음" 계산: `target - current`

### 4.2 [필수] 쿠폰 사용 시 `notes` 표시

**현재:** 쿠폰 사용(PIN 입력) 시 뜨는 창에 `notes`를 활용하지 않음.

**요청:** 쿠폰 사용 확인/진행 팝업에서 **`benefit.notes`**를 노출해 주세요.
- `notes`는 쿠폰 사용 가능 조건 (예: "최소 주문 1만원", "음료만 사용 가능", "1인 1회 한정")
- `notes`가 비어 있으면 표시하지 않으면 됨

### 4.3 [권장] 하루 적립 제한 안내

- 하루 최대 3회 적립 가능하다는 안내 문구 추가
- 적립 실패 시 에러 메시지 그대로 표시: `"하루 최대 3번까지만 스탬프를 적립할 수 있습니다. 오늘 이미 N번 적립하셨습니다."`

---

## 5. 스탬프 적립 API 요약

| 메서드 | 엔드포인트 | 설명 |
|--------|------------|------|
| POST | `/api/coupons/stamps/add/` | 스탬프 적립 (restaurant_id, pin, idem_key) |
| GET | `/api/coupons/stamps/my/?restaurant_id={id}` | 특정 식당 스탬프 현황 + rewards |
| GET | `/api/coupons/stamps/my/all/` | 전체 식당 스탬프 현황 + rewards |

---

## 6. 쿠폰 API 요약

| 메서드 | 엔드포인트 | benefit.notes |
|--------|------------|---------------|
| GET | `/api/coupons/my/` | ✅ 포함 |
| POST | `/api/coupons/check/` | ✅ 포함 (PIN 입력 시 확인용) |
| POST | `/api/coupons/redeem/` | 사용 처리 (확인 후 호출) |

---

## 7. 마이그레이션 시 유의사항

- 기존에 규칙이 없는 식당은 **5개, 10개** 기준으로 동작 (레거시)
- `rewards`가 빈 배열 `[]`인 경우: 해당 식당에 스탬프 규칙이 없을 수 있음 → 레거시(5, 10)로 fallback 표시 가능
