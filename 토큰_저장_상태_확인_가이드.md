# FCM í† í° ì €ì¥ ìƒíƒœ í™•ì¸ ê°€ì´ë“œ

## ğŸ“‹ í˜„ì¬ êµ¬ì¡° ë¶„ì„

### 1. ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°

#### User ëª¨ë¸
```python
class User(AbstractBaseUser):
    kakao_id = models.BigIntegerField(unique=True)
    fcm_token = models.CharField(max_length=255, null=True, blank=True)  # í•˜ë‚˜ë§Œ ì €ì¥
```

#### GuestUser ëª¨ë¸
```python
class GuestUser(models.Model):
    uuid = models.UUIDField(unique=True)  # ê¸°ê¸°ë³„ ê³ ìœ  ID
    fcm_token = models.CharField(max_length=255, null=True, blank=True)  # í•˜ë‚˜ë§Œ ì €ì¥
    linked_user = models.ForeignKey(User, ...)  # Userì™€ ì—°ê²° ê°€ëŠ¥
```

### 2. í† í° ì—…ë°ì´íŠ¸ API

#### GuestUser í† í° ì—…ë°ì´íŠ¸
- **ì—”ë“œí¬ì¸íŠ¸**: `POST /guests/update/fcm_token/`
- **íŒŒë¼ë¯¸í„°**: `uuid`, `fcm_token`
- **ë™ì‘**: í•´ë‹¹ UUIDì˜ GuestUserì˜ fcm_tokenì„ ë®ì–´ì“°ê¸°

#### User í† í° ì—…ë°ì´íŠ¸
- **ì—”ë“œí¬ì¸íŠ¸**: `PATCH /accounts/me/`
- **íŒŒë¼ë¯¸í„°**: `fcm_token`
- **ë™ì‘**: ì¸ì¦ëœ Userì˜ fcm_tokenì„ ë®ì–´ì“°ê¸°
- **íŠ¹ì§•**: Userì˜ fcm_tokenì´ ì—…ë°ì´íŠ¸ë˜ë©´ ì—°ê²°ëœ GuestUserë“¤ë„ ë™ê¸°í™”ë¨

### 3. í˜„ì¬ êµ¬ì¡°ì˜ ë¬¸ì œì 

#### âš ï¸ ë¬¸ì œ 1: í† í° ë®ì–´ì“°ê¸°
- **User ëª¨ë¸**: í•œ ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ í† í°ë§Œ ì €ì¥
  - ê°™ì€ kakao_idë¡œ ì—¬ëŸ¬ ê¸°ê¸° ë¡œê·¸ì¸ ì‹œ ë§ˆì§€ë§‰ í† í°ë§Œ ì €ì¥
  - ì´ì „ ê¸°ê¸°ì˜ í† í°ì´ ì‚¬ë¼ì§

- **GuestUser ëª¨ë¸**: í•œ GuestUserë‹¹ í•˜ë‚˜ì˜ í† í°ë§Œ ì €ì¥
  - ê°™ì€ UUIDë¡œ ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ì‚¬ìš© ì‹œ ë§ˆì§€ë§‰ í† í°ë§Œ ì €ì¥
  - í•˜ì§€ë§Œ UUIDëŠ” ê¸°ê¸°ë³„ë¡œ ë‹¤ë¥´ë¯€ë¡œ ì´ ë¬¸ì œëŠ” ëœí•¨

#### âš ï¸ ë¬¸ì œ 2: iOS/Android êµ¬ë¶„ ì—†ìŒ
- iOSì™€ Android ëª¨ë‘ ê°™ì€ `fcm_token` í•„ë“œ ì‚¬ìš©
- í”Œë«í¼ êµ¬ë¶„ ë¶ˆê°€ëŠ¥

#### âš ï¸ ë¬¸ì œ 3: ì—¬ëŸ¬ ê¸°ê¸° ì§€ì› ë¶ˆê°€
- í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ê¸°ê¸°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
- ë§ˆì§€ë§‰ì— ë¡œê·¸ì¸í•œ ê¸°ê¸°ì˜ í† í°ë§Œ ìœ ì§€ë¨

---

## ğŸ” í† í° ì €ì¥ ìƒíƒœ í™•ì¸ ë°©ë²•

### ë°©ë²• 1: ê´€ë¦¬ ëª…ë ¹ì–´ ì‚¬ìš©

#### UUIDë¡œ GuestUser í™•ì¸
```bash
python manage.py check_token_storage --uuid b6760e94-70c8-444a-9aa5-19c729e35699
```

#### íŠ¹ì • í† í°ê³¼ í•¨ê»˜ í™•ì¸
```bash
python manage.py check_token_storage --uuid b6760e94-70c8-444a-9aa5-19c729e35699 --token eQYL8BqINEHBj-Rc5Nbopw:APA91bHRPcQkvi7uV3...
```

#### kakao_idë¡œ User í™•ì¸
```bash
python manage.py check_token_storage --kakao-id 1234567890
```

#### User IDë¡œ í™•ì¸
```bash
python manage.py check_token_storage --user-id 1
```

#### í† í°ìœ¼ë¡œ ì§ì ‘ ê²€ìƒ‰
```bash
python manage.py check_token_storage --token eQYL8BqINEHBj-Rc5Nbopw:APA91bHRPcQkvi7uV3...
```

#### í† í° ë®ì–´ì“°ê¸° ë¬¸ì œ í™•ì¸
```bash
python manage.py check_token_storage --check-overwrite
```

### ë°©ë²• 2: Django Admin í˜ì´ì§€ ì‚¬ìš©

1. Django Admin ì ‘ì†
2. **Guests** â†’ **Guest users** ì„ íƒ
3. UUIDë¡œ ê²€ìƒ‰
4. `fcm_token` í•„ë“œ í™•ì¸

ë˜ëŠ”

1. **Accounts** â†’ **Users** ì„ íƒ
2. kakao_idë¡œ ê²€ìƒ‰
3. `fcm_token` í•„ë“œ í™•ì¸

### ë°©ë²• 3: Django Shell ì‚¬ìš©

```python
python manage.py shell

# UUIDë¡œ GuestUser í™•ì¸
from guests.models import GuestUser
guest = GuestUser.objects.get(uuid='b6760e94-70c8-444a-9aa5-19c729e35699')
print(f"FCM Token: {guest.fcm_token}")

# kakao_idë¡œ User í™•ì¸
from accounts.models import User
user = User.objects.get(kakao_id=1234567890)
print(f"FCM Token: {user.fcm_token}")

# í† í°ìœ¼ë¡œ ê²€ìƒ‰
from guests.models import GuestUser
from accounts.models import User

token = "eQYL8BqINEHBj-Rc5Nbopw:APA91bHRPcQkvi7uV3..."
guests = GuestUser.objects.filter(fcm_token=token)
users = User.objects.filter(fcm_token=token)

print(f"GuestUser: {guests.count()}ê°œ")
print(f"User: {users.count()}ê°œ")
```

---

## âœ… í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1-1. íŠ¹ì • UUID/ì‚¬ìš©ìì˜ í† í° í™•ì¸

- [ ] ì•± ë¡œê·¸ì—ì„œ UUID í™•ì¸ (ì˜ˆ: `b6760e94-70c8-444a-9aa5-19c729e35699`)
- [ ] ì•± ë¡œê·¸ì—ì„œ FCM í† í° í™•ì¸ (ì˜ˆ: `eQYL8BqINEHBj-Rc5Nbopw:APA91bHRPcQkvi7uV3...`)
- [ ] ê´€ë¦¬ ëª…ë ¹ì–´ë¡œ DB í™•ì¸:
  ```bash
  python manage.py check_token_storage --uuid b6760e94-70c8-444a-9aa5-19c729e35699 --token eQYL8BqINEHBj-Rc5Nbopw:APA91bHRPcQkvi7uV3...
  ```
- [ ] ì €ì¥ëœ í† í°ì´ ì•±ì—ì„œ ë°›ì€ í† í°ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸

### 1-2. í† í° ë®ì–´ì“°ê¸° ë¬¸ì œ í™•ì¸

- [ ] í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ê¸°ê¸°ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸
- [ ] ê° ê¸°ê¸°ì˜ í† í°ì´ ëª¨ë‘ ì €ì¥ë˜ëŠ”ì§€ í™•ì¸
- [ ] ë§ˆì§€ë§‰ ê¸°ê¸°ì˜ í† í°ë§Œ ë‚¨ëŠ”ì§€ í™•ì¸

**í™•ì¸ ë°©ë²•:**
```bash
python manage.py check_token_storage --check-overwrite
```

---

## ğŸ”§ ë¬¸ì œ í•´ê²° ë°©ë²•

### ë¬¸ì œ 1: í† í°ì´ ì €ì¥ë˜ì§€ ì•ŠìŒ

**í™•ì¸ ì‚¬í•­:**
1. ì•±ì—ì„œ í† í° ì—…ë°ì´íŠ¸ API í˜¸ì¶œì´ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
2. API ì‘ë‹µ í™•ì¸ (200 OKì¸ì§€)
3. DBì— ì‹¤ì œë¡œ ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸

**í•´ê²° ë°©ë²•:**
- ì•± ë¡œê·¸ í™•ì¸
- API ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
- DB ì§ì ‘ í™•ì¸

### ë¬¸ì œ 2: í† í°ì´ ë®ì–´ì“°ì—¬ì§

**í˜„ì¬ êµ¬ì¡°ì˜ í•œê³„:**
- User ëª¨ë¸ì€ í•œ ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ í† í°ë§Œ ì €ì¥
- ì—¬ëŸ¬ ê¸°ê¸° ì‚¬ìš© ì‹œ ë§ˆì§€ë§‰ í† í°ë§Œ ìœ ì§€

**ì„ì‹œ í•´ê²° ë°©ë²•:**
- ê° ê¸°ê¸°ë¥¼ ë³„ë„ì˜ GuestUserë¡œ ê´€ë¦¬
- ë˜ëŠ” ë§ˆì§€ë§‰ ê¸°ê¸°ì˜ í† í°ë§Œ ì‚¬ìš©

**ì¥ê¸° í•´ê²° ë°©ë²•:**
- UserDevice í…Œì´ë¸” ìƒì„±
- ì—¬ëŸ¬ ê¸°ê¸° ì§€ì› êµ¬ì¡°ë¡œ ë³€ê²½

### ë¬¸ì œ 3: iOS í† í°ì´ Android í† í°ìœ¼ë¡œ ë®ì–´ì“°ì—¬ì§

**í™•ì¸ ì‚¬í•­:**
- ê°™ì€ ì‚¬ìš©ìê°€ iOSì™€ Android ëª¨ë‘ ì‚¬ìš©í•˜ëŠ”ì§€
- ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ê¸°ê¸°ì˜ í† í°ë§Œ ì €ì¥ë˜ëŠ”ì§€

**í•´ê²° ë°©ë²•:**
- ì—¬ëŸ¬ ê¸°ê¸° ì§€ì› êµ¬ì¡°ë¡œ ë³€ê²½ í•„ìš”

---

## ğŸ“Š í˜„ì¬ êµ¬ì¡° ìš”ì•½

### ì¥ì 
- âœ… ê°„ë‹¨í•œ êµ¬ì¡°
- âœ… êµ¬í˜„ì´ ì‰¬ì›€
- âœ… GuestUserëŠ” UUID ê¸°ë°˜ìœ¼ë¡œ ê¸°ê¸°ë³„ ê´€ë¦¬ ê°€ëŠ¥

### ë‹¨ì 
- âŒ í•œ ì‚¬ìš©ìë‹¹ í•˜ë‚˜ì˜ í† í°ë§Œ ì €ì¥
- âŒ ì—¬ëŸ¬ ê¸°ê¸° ì§€ì› ë¶ˆê°€
- âŒ iOS/Android êµ¬ë¶„ ë¶ˆê°€ëŠ¥
- âŒ í† í° ë®ì–´ì“°ê¸° ë¬¸ì œ

---

## ğŸ’¡ ê°œì„  ì œì•ˆ

### ì´ìƒì ì¸ êµ¬ì¡°

```python
class UserDevice(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    device_id = models.CharField(max_length=255)  # ê¸°ê¸° ê³ ìœ  ID
    platform = models.CharField(max_length=10)  # 'ios' or 'android'
    fcm_token = models.CharField(max_length=255)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        unique_together = ['user', 'device_id']
```

**ë°œì†¡ ë¡œì§:**
```python
# í•´ë‹¹ ìœ ì €ì˜ ëª¨ë“  í™œì„± í† í°ìœ¼ë¡œ ë°œì†¡
tokens = UserDevice.objects.filter(
    user=user,
    is_active=True
).values_list('fcm_token', flat=True)
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: iOS ì•±ì—ì„œ í† í° ì €ì¥ í™•ì¸

1. iOS ì•± ì‹¤í–‰
2. UUID í™•ì¸: `b6760e94-70c8-444a-9aa5-19c729e35699`
3. FCM í† í° í™•ì¸: `eQYL8BqINEHBj-Rc5Nbopw:APA91bHRPcQkvi7uV3...`
4. í† í° ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
5. DB í™•ì¸:
   ```bash
   python manage.py check_token_storage --uuid b6760e94-70c8-444a-9aa5-19c729e35699 --token eQYL8BqINEHBj-Rc5Nbopw:APA91bHRPcQkvi7uV3...
   ```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì—¬ëŸ¬ ê¸°ê¸° ì‚¬ìš© ì‹œ í† í° ë®ì–´ì“°ê¸° í™•ì¸

1. ê°™ì€ ì‚¬ìš©ìê°€ iOSì™€ Android ëª¨ë‘ ë¡œê·¸ì¸
2. ê° ê¸°ê¸°ì˜ í† í° í™•ì¸
3. DBì—ì„œ ë§ˆì§€ë§‰ í† í°ë§Œ ë‚¨ëŠ”ì§€ í™•ì¸:
   ```bash
   python manage.py check_token_storage --check-overwrite
   ```

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2024ë…„









