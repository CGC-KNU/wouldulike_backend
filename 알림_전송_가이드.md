# 알림 전송 가이드

이 프로젝트에서는 Firebase Cloud Messaging (FCM) HTTP v1 API를 사용하여 푸시 알림을 전송합니다.

## 1. 기본 사용 방법

### Python 코드에서 직접 전송

```python
from notifications.utils import send_notification
from accounts.models import User

# 특정 사용자에게 알림 전송
user = User.objects.get(kakao_id=123456789)
if user.fcm_token:
    result = send_notification(
        tokens=[user.fcm_token],
        message="안녕하세요! 새로운 쿠폰이 도착했습니다."
    )
    print(result)
    # 결과: {'success': 1, 'failure': 0, 'succeeded_tokens': [...], 'failed_tokens': []}
```

### 여러 사용자에게 일괄 전송

```python
from notifications.utils import send_notification
from accounts.models import User

# FCM 토큰이 있는 모든 사용자에게 전송
users = User.objects.exclude(fcm_token__isnull=True).exclude(fcm_token="")
tokens = [user.fcm_token for user in users]

result = send_notification(
    tokens=tokens,
    message="공지사항: 새로운 기능이 추가되었습니다!"
)

if result:
    print(f"성공: {result['success']}개, 실패: {result['failure']}개")
```

### 특정 조건의 사용자에게만 전송

```python
from notifications.utils import send_notification
from accounts.models import User

# 특정 타입 코드를 가진 사용자에게만 전송
users = User.objects.filter(
    type_code="ISTJ",
    fcm_token__isnull=False
).exclude(fcm_token="")

tokens = list(users.values_list("fcm_token", flat=True))

result = send_notification(
    tokens=tokens,
    message="ISTJ 타입을 위한 특별한 추천이 있습니다!"
)
```

## 2. 스케줄링된 알림 전송

### Notification 모델 사용

```python
from notifications.models import Notification
from django.utils import timezone
from datetime import timedelta

# 예약된 알림 생성
notification = Notification.objects.create(
    content="내일 오후 3시에 특별 이벤트가 시작됩니다!",
    scheduled_time=timezone.now() + timedelta(days=1, hours=15),
    sent=False
)
```

### 예약된 알림 전송 실행

```bash
# 관리 명령어로 예약된 알림 전송
python manage.py send_scheduled_notifications
```

이 명령어는:
- `scheduled_time`이 현재 시간 이하인 알림을 찾음
- `sent=False`인 알림만 전송
- 모든 GuestUser의 FCM 토큰으로 전송
- 전송 후 `sent=True`로 업데이트
- 무효한 토큰(UNREGISTERED 등) 자동 제거

## 3. Django Shell에서 사용

```bash
python manage.py shell
```

```python
# 1. 단일 사용자에게 전송
from notifications.utils import send_notification
from accounts.models import User

user = User.objects.get(kakao_id=4424485763)
if user.fcm_token:
    result = send_notification([user.fcm_token], "테스트 알림입니다")
    print(result)

# 2. 모든 사용자에게 전송
from accounts.models import User
tokens = list(User.objects.exclude(fcm_token__isnull=True)
              .exclude(fcm_token="")
              .values_list("fcm_token", flat=True))
result = send_notification(tokens, "전체 공지사항입니다")
print(f"성공: {result['success']}, 실패: {result['failure']}")

# 3. 예약 알림 생성
from notifications.models import Notification
from django.utils import timezone
from datetime import timedelta

Notification.objects.create(
    content="1시간 후 특별 이벤트 시작!",
    scheduled_time=timezone.now() + timedelta(hours=1),
    sent=False
)
```

## 4. API 엔드포인트에서 사용

```python
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from notifications.utils import send_notification
from accounts.models import User

class SendNotificationView(APIView):
    def post(self, request):
        user_id = request.data.get('user_id')
        message = request.data.get('message')
        
        if not user_id or not message:
            return Response(
                {'detail': 'user_id and message are required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            user = User.objects.get(id=user_id)
            if not user.fcm_token:
                return Response(
                    {'detail': 'User has no FCM token'},
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            result = send_notification([user.fcm_token], message)
            
            if result and result['success'] > 0:
                return Response({
                    'status': 'success',
                    'message': 'Notification sent successfully'
                })
            else:
                return Response({
                    'status': 'failed',
                    'detail': result
                }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
                
        except User.DoesNotExist:
            return Response(
                {'detail': 'User not found'},
                status=status.HTTP_404_NOT_FOUND
            )
```

## 5. 반환값

`send_notification()` 함수는 다음 형식의 딕셔너리를 반환합니다:

```python
{
    "success": 2,  # 성공한 토큰 수
    "failure": 1,  # 실패한 토큰 수
    "succeeded_tokens": ["token1", "token2"],  # 성공한 토큰 리스트
    "failed_tokens": [  # 실패한 토큰과 오류 정보
        {
            "token": "token3",
            "status_code": 404,
            "response": {
                "error": {
                    "status": "NOT_FOUND",
                    "message": "..."
                }
            }
        }
    ]
}
```

토큰이 없거나 세션을 만들 수 없는 경우 `None`을 반환합니다.

## 6. 설정 요구사항

알림 전송을 위해 다음 환경 변수가 설정되어 있어야 합니다:

- `FCM_PROJECT_ID`: Firebase 프로젝트 ID
- `FCM_SERVICE_ACCOUNT_FILE`: 서비스 계정 JSON 파일 경로
  또는
- `FCM_SERVICE_ACCOUNT_JSON`: 서비스 계정 JSON 문자열

또는 `GOOGLE_APPLICATION_CREDENTIALS` 환경 변수로 설정할 수 있습니다.

## 7. FCM 토큰 관리

### 사용자 FCM 토큰 저장

```python
from accounts.models import User

user = User.objects.get(kakao_id=123456789)
user.fcm_token = "새로운_FCM_토큰"
user.save(update_fields=['fcm_token'])
```

### 무효한 토큰 자동 제거

`send_scheduled_notifications` 명령어는 자동으로 무효한 토큰을 제거합니다:
- `UNREGISTERED` 오류 코드
- `NOT_FOUND` 상태

수동으로 제거하려면:

```python
from accounts.models import User

# 특정 토큰 제거
User.objects.filter(fcm_token="무효한_토큰").update(fcm_token="")
```

## 8. 예제: 쿠폰 발급 시 알림 전송

```python
from notifications.utils import send_notification
from accounts.models import User

def issue_coupon_with_notification(user, coupon):
    # 쿠폰 발급 로직...
    
    # 알림 전송
    if user.fcm_token:
        message = f"새로운 쿠폰이 발급되었습니다! 코드: {coupon.code}"
        result = send_notification([user.fcm_token], message)
        
        if result and result['success'] > 0:
            print(f"알림 전송 성공: {user.kakao_id}")
        else:
            print(f"알림 전송 실패: {result}")
```

## 9. 주의사항

1. **토큰 유효성**: FCM 토큰은 시간이 지나면 무효화될 수 있습니다. 실패한 토큰은 정기적으로 정리해야 합니다.

2. **배치 전송**: 많은 사용자에게 전송할 때는 배치로 나누어 전송하는 것을 권장합니다.

3. **에러 처리**: `send_notification()`의 반환값을 확인하여 실패한 토큰을 처리하세요.

4. **비동기 처리**: 대량 전송 시 Celery 등의 작업 큐를 사용하는 것을 고려하세요.

## 10. 테스트

```python
# Django shell에서 테스트
from notifications.utils import send_notification

# 테스트 토큰으로 전송 (실제 기기 토큰 사용)
test_token = "실제_FCM_토큰"
result = send_notification([test_token], "테스트 알림입니다")
print(result)
```

