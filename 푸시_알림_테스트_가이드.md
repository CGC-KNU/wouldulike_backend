# 푸시 알림 테스트 가이드

## 📋 개요

실제 알림을 전송하지 않고 푸시 알림 설정을 검증하고 테스트할 수 있는 방법을 안내합니다.

---

## 🔍 테스트 명령어 사용법

### 1. 기본 테스트 (드라이런 모드)

**실제 알림을 전송하지 않고 설정만 검증합니다.**

```bash
python manage.py test_notification
```

**기본 동작:**
- DB에 저장된 모든 FCM 토큰을 사용하여 검증
- 기본 메시지: "테스트 알림 메시지입니다."
- 실제 알림은 전송되지 않음

**출력 예시:**
```
🔍 테스트 모드 (드라이런): 실제 알림은 전송되지 않습니다.

================================================================================
푸시 알림 설정 검증 시작
================================================================================

📊 GuestUser 토큰: 5개
📊 User 토큰: 10개
📊 총 고유 토큰: 12개

🔍 알림 설정 검증 중...

================================================================================
검증 결과
================================================================================

📋 설정 상태:
   프로젝트 ID: your-project-id
   인증 가능: ✅
   엔드포인트: https://fcm.googleapis.com/v1/projects/your-project-id/messages:send
   메시지 길이: 15자

📱 토큰 정보:
   총 토큰 수: 12개
   유효한 토큰: 12개
   무효한 토큰: 0개

ℹ️  정보:
   • 총 토큰 수: 12
   • 유효한 토큰 수: 12
   • 무효한 토큰 수: 0

================================================================================
✅ 검증 통과: 알림 전송이 가능한 상태입니다.

💡 실제 알림을 전송하려면 --send 옵션을 사용하세요:
   python manage.py test_notification --send
================================================================================
```

### 2. 커스텀 메시지로 테스트

```bash
python manage.py test_notification --message "안녕하세요! 이것은 테스트 메시지입니다."
```

### 3. 특정 토큰으로 테스트

```bash
python manage.py test_notification --token "your-fcm-token-here"
```

### 4. 실제 알림 전송 (주의!)

**⚠️ 실제로 알림이 전송됩니다!**

```bash
python manage.py test_notification --send
```

또는 커스텀 메시지와 함께:

```bash
python manage.py test_notification --send --message "실제 알림 메시지"
```

---

## 📅 예약된 알림 테스트

### 1. 예약된 알림 검증 (드라이런 모드)

**실제 전송 없이 예약된 알림들을 검증합니다.**

```bash
python manage.py send_scheduled_notifications --dry-run
```

**출력 예시:**
```
Found 3 notification(s) to send
Found 5 guest tokens and 10 user tokens
Total unique tokens: 12

⚠️  드라이런 모드: 실제 알림은 전송되지 않습니다.

[DRY-RUN] Validating notification 1: 쿠폰이 곧 만료됩니다...

✅ Notification 1 validation passed: 12 valid tokens

✅ 검증 완료: 3개 알림 검증됨 (실패: 0, 부분 실패: 0)

💡 실제 알림을 전송하려면 --dry-run 옵션 없이 실행하세요.
```

### 2. 예약된 알림 실제 전송

```bash
python manage.py send_scheduled_notifications
```

---

## 🔎 검증 항목

테스트 명령어는 다음 항목들을 검증합니다:

### ✅ 설정 검증
- [ ] FCM 서비스 계정 인증 정보가 올바른지 확인
- [ ] 프로젝트 ID가 설정되어 있는지 확인
- [ ] FCM 엔드포인트 URL이 올바른지 확인
- [ ] 인증 토큰을 가져올 수 있는지 확인

### ✅ 메시지 검증
- [ ] 메시지가 비어있지 않은지 확인
- [ ] 메시지 길이가 적절한지 확인 (2000자 이하 권장)

### ✅ 토큰 검증
- [ ] 토큰이 존재하는지 확인
- [ ] 토큰 형식이 올바른지 확인
- [ ] 토큰 길이가 적절한지 확인

### ✅ 페이로드 검증
- [ ] FCM API 요청 페이로드 형식이 올바른지 확인

---

## 📊 검증 결과 해석

### ✅ 성공적인 검증

```
✅ 검증 통과: 알림 전송이 가능한 상태입니다.
```

**의미:**
- 모든 설정이 올바르게 구성됨
- 토큰들이 유효한 형식임
- 실제 알림 전송이 가능한 상태

### ❌ 검증 실패

```
❌ 검증 실패: 위의 문제점을 해결한 후 다시 시도하세요.
```

**일반적인 문제점:**

1. **FCM 서비스 계정 인증 정보 없음**
   ```
   ❌ 문제점:
      • FCM 서비스 계정 인증 정보를 불러올 수 없습니다.
        FCM_SERVICE_ACCOUNT_FILE 또는 FCM_SERVICE_ACCOUNT_JSON 환경 변수를 확인하세요.
   ```
   **해결:** 환경 변수 설정 확인

2. **프로젝트 ID 없음**
   ```
   ❌ 문제점:
      • FCM project id is not configured.
   ```
   **해결:** `FCM_PROJECT_ID` 환경 변수 설정

3. **토큰 없음**
   ```
   ❌ 문제점:
      • 유효한 FCM 토큰이 없습니다.
   ```
   **해결:** DB에 FCM 토큰이 저장되어 있는지 확인

4. **메시지 없음**
   ```
   ❌ 문제점:
      • 알림 메시지가 비어있습니다.
   ```
   **해결:** `--message` 옵션으로 메시지 지정

### ⚠️ 경고 메시지

경고는 검증을 통과하지만 주의가 필요한 사항입니다:

1. **메시지가 너무 긴 경우**
   ```
   ⚠️  경고:
      • 메시지가 너무 깁니다 (2500자). FCM 권장 길이는 2000자 이하입니다.
   ```

2. **토큰 길이가 짧은 경우**
   ```
   ⚠️  경고:
      • 토큰 길이가 짧습니다 (30자). 유효한 FCM 토큰인지 확인하세요.
   ```

---

## 🛠️ 문제 해결

### 문제 1: "FCM 서비스 계정 인증 정보를 불러올 수 없습니다"

**확인 사항:**
1. 환경 변수가 설정되어 있는지 확인:
   ```bash
   echo $FCM_SERVICE_ACCOUNT_FILE
   # 또는
   echo $FCM_SERVICE_ACCOUNT_JSON
   ```

2. 파일 경로가 올바른지 확인:
   ```bash
   ls -l $FCM_SERVICE_ACCOUNT_FILE
   ```

3. 파일 권한 확인:
   ```bash
   chmod 600 $FCM_SERVICE_ACCOUNT_FILE
   ```

**해결 방법:**
- `.env` 파일에 환경 변수 추가
- 또는 서비스 계정 JSON 파일 경로 확인

### 문제 2: "프로젝트 ID가 설정되지 않았습니다"

**확인 사항:**
```bash
echo $FCM_PROJECT_ID
```

**해결 방법:**
- Firebase Console에서 프로젝트 ID 확인
- `.env` 파일에 `FCM_PROJECT_ID` 추가

### 문제 3: "유효한 FCM 토큰이 없습니다"

**확인 사항:**
1. DB에 토큰이 저장되어 있는지 확인:
   ```python
   python manage.py shell
   >>> from accounts.models import User
   >>> from guests.models import GuestUser
   >>> User.objects.exclude(fcm_token__isnull=True).exclude(fcm_token="").count()
   >>> GuestUser.objects.exclude(fcm_token__isnull=True).exclude(fcm_token="").count()
   ```

2. iOS 앱에서 토큰이 제대로 전송되는지 확인

**해결 방법:**
- iOS 앱에서 FCM 토큰을 백엔드로 전송하는 API 호출 확인
- 토큰 저장 로직 확인

### 문제 4: "인증 토큰을 가져올 수 없습니다"

**확인 사항:**
1. 서비스 계정 키 파일이 올바른 형식인지 확인
2. 서비스 계정에 필요한 권한이 있는지 확인:
   - Firebase Cloud Messaging API 권한

**해결 방법:**
- Firebase Console에서 새로운 서비스 계정 키 생성
- 서비스 계정에 "Firebase Cloud Messaging Admin" 역할 부여

---

## 💡 사용 시나리오

### 시나리오 1: 배포 전 검증

배포하기 전에 푸시 알림 설정이 올바른지 확인:

```bash
python manage.py test_notification
```

### 시나리오 2: 특정 사용자에게 테스트

특정 FCM 토큰으로만 테스트:

```bash
python manage.py test_notification --token "user-fcm-token" --message "개인 테스트 메시지"
```

### 시나리오 3: 예약된 알림 확인

예약된 알림들이 올바르게 설정되었는지 확인:

```bash
python manage.py send_scheduled_notifications --dry-run
```

### 시나리오 4: 실제 알림 전송 테스트

모든 설정이 올바른지 확인한 후 실제 알림 전송:

```bash
# 1단계: 검증
python manage.py test_notification

# 2단계: 실제 전송 (검증 통과 후)
python manage.py test_notification --send --message "실제 테스트 알림"
```

---

## 📝 명령어 요약

| 명령어 | 설명 | 실제 전송 여부 |
|--------|------|----------------|
| `python manage.py test_notification` | 기본 테스트 (모든 토큰) | ❌ |
| `python manage.py test_notification --message "메시지"` | 커스텀 메시지로 테스트 | ❌ |
| `python manage.py test_notification --token "토큰"` | 특정 토큰으로 테스트 | ❌ |
| `python manage.py test_notification --send` | 실제 알림 전송 | ✅ |
| `python manage.py send_scheduled_notifications --dry-run` | 예약된 알림 검증 | ❌ |
| `python manage.py send_scheduled_notifications` | 예약된 알림 전송 | ✅ |

---

## 🔒 안전 팁

1. **항상 먼저 드라이런 모드로 테스트**
   - 실제 전송 전에 반드시 검증 수행

2. **프로덕션 환경에서 주의**
   - `--send` 옵션 사용 시 실제 사용자에게 알림이 전송됨
   - 테스트 메시지가 아닌 경우 신중하게 사용

3. **토큰 관리**
   - 무효한 토큰은 자동으로 정리됨
   - 정기적으로 토큰 상태 확인

---

**마지막 업데이트**: 2024년










